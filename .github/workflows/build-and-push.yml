name: Build and Push to Local Registry

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'README_DEPLOYMENT.md'
      - '*.sh'
      - 'k8s/**'

env:
  REGISTRY: 116.32.135.243:30500
  IMAGE_NAME: church-website

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure insecure registry
      run: |
        sudo mkdir -p /etc/docker
        echo '{"insecure-registries": ["116.32.135.243:30500"]}' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker
        sleep 5
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/arm64
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          network=host
        config-inline: |
          [registry."116.32.135.243:30500"]
            http = true
            insecure = true
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.prod
        platforms: linux/arm64
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
